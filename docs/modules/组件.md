# 组件
组件由 3 部分组件, js,iOS,android 
## xengine.api

JS API 将抹平 ios 与 android 等其他平台的调用差异. 

主要包含路由, 网络,存储, 硬件调用, 等.



* API约束（包括调用格式，传参格式，回调格式）
* 功能规划（约定这个框架应该提供什么样的功能）
* 权限校验（校验后才能调用，包括权限校验的代码格式，校验一些什么内容，以及哪些API无需校验）
* 模块化的API（按照模块划分，每一个模块可以作为单独的组件，便于拓展）
* 其它优化（如在PC端调试API的页面，部分API支持Promise等）

### API 约束

约定所有API统一采用如下调用方式

``` js
xengine.模块名.方法({
    参数1: "",
    参数2: "",
    success: fucntion(result) {
        // 成功回调
    },
    error: fucntion(error) {
        // 失败回调
    }
});
// 或者使用 promise 
xengine.模块名.方法({
    参数1: "",
    参数2: "")
.then(result=>{})
.catch(error=>{})

```

**约束说明**

* 所有接口都为异步调用
* 接收一个`object`类型的参数
* 成功回调`success`
  * 通过`result`获取成功数据
  * 回调函数的触发时机由具体的API决定，有的API是调用时即可回调（短期），有的是某个事件触发后才被回调（长期）
* 失败回调`error`，所有的API调用错误都会走失败回调



> promise 一样.



### 功能规划

``` js
xengine   
		|- net
		|   |- request  post get put head
    |   |- fileupload  
		|- ui               // 系统ui组件
    |   |- toast
    |   |- alert
    |   |- confirm
    |   |- prompt
    |   |- showWaiting
    |   |- closeWaiting
    |   |- actionSheet
    |   |- pickDate
    |   |- pickTime
    |   |- pickDateTime
    |   |- popWindow
    |- page             // 页面（webview）管理
    |   |- open
    |   |- openLocal
    |   |- close
    |   |- reload
    |- navigator        // 导航栏控制
    |   |- setTitle
    |   |- setMultiTitle
    |   |- hookSysBack
    |   |- hookBackBtn
    |   |- setRightBtn
    |   |- setLeftBtn
    |   |- setRightMenu
    |- auth             // 权限认证相关
    |   |- getToken
    |- device           // 设备相关
    |   |- setOrientation
    |   |- getDeviceId
    |   |- getNetWorkInfo
    |   |- getVendorInfo
    |   |- closeInputKeyboard
    |   |- vibrate
    |   |- callPhone
    |   |- sendMsg
    |- runtime          // 运行环境
    |   |- launchApp
    |   |- getAppVersion
    |   |- getxengineVersion
    |   |- getGeolocation
    |   |- clearCache
    |   |- clipboard
    |   |- openUrl
    |- util             // 其它工具
    |   |- scan
    |   |- selectImage
    |   |- cameraImage
    |   |- selectFile
    |   |- openFile
```



> 详情见日后 xengine.api 文档.md.

### 权限校验(可选)

根据不同需求，可以划分以下等级。

* 平台级别的（像钉钉、微信这类对外开放的），需要配合后台，有完整的授权，签名，校验机制
* 项目级别的（N个项目同一个框架，但业务各不相同），简单的应用内部配置，直接校验一些域名白名单信息即可

``` js
xengine.error(function(error) {
    // 全局错误处理
});

xengine.config({
    ...
});
xengine.ready(function() {
    // TODO: 处理验证成功后的事情，例如调用api
});
```

如果`config`失败或者没有校验，那么敏感API都无法调用

**无需校验就可用的API**

并不是所有API都需校验后才能用，我们约定以下API默认就可用（这里是一个粗糙的划分，实际上可以精确到每一个API）

``` js
ui模块的所有API
page模块的所有API
navigator模块的所有API
```



###  模块化

有一个全局变量`xengine`，但API并不是直接绑定在全局变量下，而是按模块划分，譬如

``` js
xengine.ui
xengine.device
xengine.page
...
```



**组件API的拓展机制**

默认情况下，框架会注册以下组件

``` js
ui
page
navigator
auth
device
runtime
util
```

但是假设某项目中突然遇到了一个需求，要新增一个支付功能，并且要以API的形式提供给H5页面调用，该如何实现呢？

各个项目可以拓展自己的组件,如下

``` js
// 1.前端config时，传入需要注册的组件别名
xengine.config({
   user_modules: ['pay', 'speech']
});
// 2.原生框架中，接收到config后，基于传入的别名，去对应项目配置文件中查询路径，然后将对应路径的API实现类注册
// 对应的组件的API实现类不是放框架中的，而是由各自的项目管理的，到时候框架就是一个固定的库，给各个项目引用
// 3.前端中，通过一个固定的方法，调用刚注册的组件API中的功能
xengine.callApi({
    funcName: 'xxx',
    muduleName: 'pay',
    ...
    data: {},
    success: function(result) {},
    error: function(error) {},
});
```

通过这一套机制，可以保持框架的可拓展性，就算应用不同的项目中，N多的功能，也能通过这种方法拓展，保持一致的使用

如果组件已完善, 可以将组件合并归类到正式引擎模块. 调用方法改为

```
xengine.<muduleName>.<funcName>
```

## 组件

组件的主要作用就是提供 h5 到本地的 adapter. 组件的加载主要有两种方案.

* 通用组件:直接集成到应用引擎.直接集成到应用引擎从开发速度与稳定性来讲, 都是最优.
* 可选组件:动态加载, 主要解决的问题是, 引擎打包后过于膨胀.
二进制的更新在 android 上有非常成熟的解决方案. 而 ios 相对来说都是些厂商的黑科技. 开源的已全被封了. 如jspatch, rollout.io

*在引擎 1.0 阶段. 组件将会直接集成到引擎一起发布.*

 

> 组件详细文档见组件 1.0 规范文档. *重点是统一 android 与 iOS 的接口。*

组件示例:

* toast
* 消息推送
* 统计埋点
* 统一存储与读取
* 调用摄像头 / 相册
* 社交分享
* 定位
* 设备标识

参考 dcloud apicloud https://www.html5plus.org/doc

### 权限申请

iOS: 按本地应用申请即可.

android: https://developer.android.google.cn/training/permissions/usage-notes#dont-overwhelm

权限询问的时机:

|  | CRITICAL | CRITICAL |  |
| --- | -------- | -------- | --- |
| UNCLEAR | 启动时,告诉用户为什么需要,弹出 | 启动时,直接弹出 | CLEAR |
| UNCLEAR | 在使用时,告诉用户为什么需要,弹出 | 在使用时,直接弹出 | CLEAR |
|  | NON-CRITICAL | NON-CRITICAL |  |



[模板](https://www.github.com/zk4/x-engine-module-template)
