 

## 架构图

 ![image-20200713230142933](././assets/75a77b34-5499-4a80-bd59-0350a72ee9e0.png)



## web 容器选型

android 各平台 web 引擎差异太大, android 将统一基于 X5 web 引擎.

iOS 端将统一使用 WkWebview

## h5 与 native 交互

js <-> native ,可同步, 可异步. 

数据仅为简单数据的传递. 会有一定性能损失.


## webview 离线渲染

离线渲染保证了平滑的页面切换, 达到与原生基本一样的体验. 

可根据不同性能的机型, 使用双缓冲渲染, 三缓冲渲染, 以及 池化 webview .

三者都支持无限制下一页.

|            | 原生动画 | 性能           | 历史页面状态保持                       | 无缝后退 | 无缝前进 |
| ---------- | -------- | -------------- | -------------------------------------- | -------- | -------- |
| 双缓冲     | 支持     | 很高           | 能通过 url 复现界面,仅中间状态无法保持 | 支持     | 不支持   |
| 三缓冲     | 支持     | 高             | 能通过 url 复现界面,仅中间状态无法保持 | 支持     | 支持     |
| 无限渲染池 | 支持     | 随页面层级而定 | 支持                                   | 支持     | 支持     |

双缓冲渲染:

![2 buffer](././assets/96d545a3-f590-4702-af05-81333fb828f2.gif )

三缓冲渲染: 

与双缓冲的区别在于, forward buffer 永远是空, 这样不会出现闪历史界面的问题.

![3webview-version 3](././assets/045e984e-7bab-4181-95d2-b031f8b7ce56.gif)

池化 webview 渲染池:

通用技术. 模拟线程池, 预加载 n 个, 根据需求自动收缩增长. 实现最简单, 效果最好, 唯一的缺点, 吃内存.

## 组件化

组件分为[通用组件](./docs/modules/组件-规范.md#组件分类),与[可选组件](./docs/modules/组件-规范.md#组件分类)

通用组件示例: [原生导航](./docs/modules/common/组件-原生导航.md)

 

**统一网络**

网络是除缓存外最核心的一块功能. 

需要将 h5 的网络统一由 native 做一层代理, 来解决 cookie 共享, 安全, 跨域, 缓存, 路由等问题.

浏览器本身自带的网络请求功能, 只做加载第三方链接的标签资源用. 要达到如微信小程序的感觉, 可直接屏蔽.

其他请求全必须走本地网络.

方案会基于异步封装 native 网络请求.



![image-20200615183020656](././assets/d1bea368-81fb-4ef3-b069-5695c2a61fc9.png)

*白名单*

统一网络出口要设白名单， 防止xss。

白名单配置在服务器上。在下载离线包时，读入配置。

配置做签名，防止篡改。

## 离线机制
见 [离线包](./docs/microApp/微应用-离线服务器.md)

